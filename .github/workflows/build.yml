name: Build Pipeline

# è§¦å‘æ¡ä»¶ï¼šbuild åˆ†æ”¯è¢«åˆ›å»ºæˆ–æ¨é€
on:
  push:
    branches:
      - 'build'
      - 'build-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'æ„å»ºç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.1ï¼‰'
        required: false
        default: 'dev'

permissions:
  contents: write

jobs:
  # æ„å»ºä¿¡æ¯
  build-info:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_time: ${{ steps.version.outputs.build_time }}
      branch: ${{ steps.version.outputs.branch }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          # ä» version.json è¯»å–ç‰ˆæœ¬å·
          if [ ! -f "version.json" ]; then
            echo "âŒ é”™è¯¯: version.json æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          VERSION=$(cat version.json | grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: version.json ä¸­æœªæ‰¾åˆ° version å­—æ®µ"
            exit 1
          fi
          
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          COMMIT=$(git rev-parse --short HEAD)
          BRANCH="${GITHUB_REF#refs/heads/}"
          
          # æ›´æ–° version.json ä¸­çš„æ„å»ºä¿¡æ¯
          cat > version.json << EOF
          {
            "version": "$VERSION",
            "build_time": "$BUILD_TIME",
            "commit": "$COMMIT",
            "branch": "$BRANCH"
          }
          EOF
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: $VERSION"
          echo "â° æ„å»ºæ—¶é—´: $BUILD_TIME"
          echo "ğŸ”– æäº¤å“ˆå¸Œ: $COMMIT"
          echo "ğŸŒ¿ æ„å»ºåˆ†æ”¯: $BRANCH"

  # å¤šå¹³å°æ„å»º
  build:
    name: æ„å»º ${{ matrix.os }}-${{ matrix.arch }}
    needs: build-info
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
          # macOS
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          # Windows
          - os: windows
            arch: amd64
            runner: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: ä½¿ç”¨æ„å»ºè„šæœ¬æ„å»º
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ needs.build-info.outputs.version }}
          BUILD_TIME: ${{ needs.build-info.outputs.build_time }}
          OUTPUT_DIR: dist
          LOG_DIR: logs
        run: |
          # ç¡®ä¿æ„å»ºè„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x build.sh
          
          # ç›´æ¥è°ƒç”¨æ„å»ºè„šæœ¬ï¼Œå®ƒä¼šè‡ªåŠ¨æ£€æµ‹ GOOS å’Œ GOARCH ç¯å¢ƒå˜é‡
          # å¹¶æ„å»ºæŒ‡å®šçš„å¹³å°ç‰ˆæœ¬
          ./build.sh --no-clean
        shell: bash
      
      - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          # æ„å»ºè„šæœ¬å·²ç»ç”Ÿæˆäº†æ­£ç¡®çš„æ–‡ä»¶å
          BINARY_NAME="cursortoolset-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          echo "ğŸ§ª æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶..."
          
          # æ£€æŸ¥æ¶æ„æ˜¯å¦åŒ¹é…ï¼ˆé¿å…è·¨æ¶æ„æ‰§è¡Œé”™è¯¯ï¼‰
          RUNNER_ARCH=$(uname -m)
          TARGET_ARCH="${{ matrix.arch }}"
          
          # æ¶æ„æ˜ å°„
          case "$RUNNER_ARCH" in
            x86_64)
              RUNNER_ARCH_NORM="amd64"
              ;;
            aarch64|arm64)
              RUNNER_ARCH_NORM="arm64"
              ;;
            *)
              RUNNER_ARCH_NORM="$RUNNER_ARCH"
              ;;
          esac
          
          if [ "$RUNNER_ARCH_NORM" = "$TARGET_ARCH" ]; then
            chmod +x "dist/$BINARY_NAME" || true
            ./"dist/$BINARY_NAME" --version
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸  è·³è¿‡è·¨æ¶æ„æµ‹è¯•ï¼ˆRunner: $RUNNER_ARCH_NORM, Target: $TARGET_ARCHï¼‰"
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å·²ç”Ÿæˆï¼Œæ¶æ„éªŒè¯é€šè¿‡"
            ls -lh "dist/$BINARY_NAME"
          fi
        shell: bash
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          # æ„å»ºè„šæœ¬å·²ç»ç”Ÿæˆäº† BUILD_INFO æ–‡ä»¶ï¼Œè¿™é‡Œåªéœ€è¦ç”Ÿæˆæ ¡éªŒå’Œ
          BINARY_NAME="cursortoolset-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          BINARY_PATH="dist/$BINARY_NAME"
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$BINARY_PATH" > "dist/$BINARY_NAME.sha256"
          else
            shasum -a 256 "$BINARY_PATH" > "dist/$BINARY_NAME.sha256"
          fi
          
          echo "ğŸ“‹ æ ¡éªŒå’Œ:"
          cat "dist/$BINARY_NAME.sha256"
          
          # æ„å»ºè„šæœ¬å·²ç»ç”Ÿæˆäº† BUILD_INFO æ–‡ä»¶
          BUILD_INFO="dist/BUILD_INFO-${{ matrix.os }}-${{ matrix.arch }}.txt"
          if [ -f "$BUILD_INFO" ]; then
            echo "ğŸ“„ æ„å»ºä¿¡æ¯æ–‡ä»¶ï¼ˆç”± build.sh ç”Ÿæˆï¼‰:"
            cat "$BUILD_INFO"
          fi
        shell: bash
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: cursortoolset-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/cursortoolset-${{ matrix.os }}-${{ matrix.arch }}*
            dist/BUILD_INFO-${{ matrix.os }}-${{ matrix.arch }}.txt
          retention-days: 30
      
      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: logs/
          retention-days: 7
  
  # æ„å»ºæ€»ç»“
  build-summary:
    name: æ„å»ºæ€»ç»“
    needs: [build-info, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: ç”Ÿæˆæ„å»ºæ€»ç»“
        run: |
          echo "# æ„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.build-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: ${{ needs.build-info.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ needs.build-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æ¶æ„ | å¤§å° | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          cd artifacts
          for dir in */; do
            cd "$dir"
            for file in cursortoolset-*; do
              if [[ ! "$file" =~ \.sha256$ ]]; then
                SIZE=$(ls -lh "$file" | awk '{print $5}')
                SHA=$(cat "${file}.sha256" 2>/dev/null | awk '{print substr($1,1,16)"..."}' || echo "N/A")
                PLATFORM=$(echo "$file" | sed 's/cursortoolset-//' | sed 's/-.*//')
                ARCH=$(echo "$file" | sed 's/.*-//' | sed 's/\.exe$//')
                echo "| $PLATFORM | $ARCH | $SIZE | \`$SHA\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            cd ..
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… æ„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œä¿ç•™ 30 å¤©ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚éœ€å‘å¸ƒï¼Œè¯·è¿è¡Œ **Release Pipeline** å·¥ä½œæµï¼ŒæŒ‡å®šæ­¤æ„å»ºçš„ç‰ˆæœ¬å·ã€‚" >> $GITHUB_STEP_SUMMARY
      
      - name: åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ æ‰€æœ‰æ„å»ºäº§ç‰©:"
          find artifacts -type f ! -name "*.sha256" ! -name "BUILD_INFO*.txt" -exec ls -lh {} \;
          
          echo ""
          echo "ğŸ“„ æ„å»ºä¿¡æ¯æ–‡ä»¶:"
          find artifacts -name "BUILD_INFO*.txt" -exec cat {} \;

