# Dec æ­£å¼å‘å¸ƒæµæ°´çº¿
# åŠŸèƒ½ï¼šå°†å·²æµ‹è¯•é€šè¿‡çš„ test ç‰ˆæœ¬æå‡ä¸ºæ­£å¼ç‰ˆæœ¬ï¼ˆä¸é‡æ–°æž„å»ºï¼‰
# è§¦å‘ï¼šæŽ¨é€ v* tag

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          TEST_TAG="test-${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "test_tag=${TEST_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Release Version: ${VERSION}"
          echo "ðŸ“Œ Test Tag: ${TEST_TAG}"

      - name: Download artifacts from test release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEST_TAG="${{ steps.version.outputs.test_tag }}"
          
          echo "ðŸ“¥ ä»Ž ${TEST_TAG} ä¸‹è½½æž„å»ºäº§ç‰©..."
          mkdir -p dist
          
          # ä¸‹è½½ test release çš„æ‰€æœ‰èµ„äº§
          if ! gh release download "${TEST_TAG}" --dir dist --pattern "dec-*"; then
            echo "âŒ æœªæ‰¾åˆ°æµ‹è¯•ç‰ˆæœ¬ ${TEST_TAG}"
            echo "è¯·å…ˆæŽ¨é€ test tag: git tag ${TEST_TAG} && git push origin ${TEST_TAG}"
            exit 1
          fi
          
          echo "ðŸ“¦ ä¸‹è½½çš„æ–‡ä»¶:"
          ls -la dist/

      - name: Verify artifacts
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
          
          # æ£€æŸ¥å¿…è¦çš„å¹³å°æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          REQUIRED_FILES=(
            "dec-linux-amd64"
            "dec-linux-arm64"
            "dec-darwin-amd64"
            "dec-darwin-arm64"
            "dec-windows-amd64.exe"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "dist/${file}" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: ${file}"
              exit 1
            fi
            echo "âœ… ${file}"
          done
          
          # éªŒè¯ SHA256ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          cd dist
          for sha_file in *.sha256; do
            if [ -f "$sha_file" ]; then
              if sha256sum -c "$sha_file"; then
                echo "âœ… SHA256 éªŒè¯é€šè¿‡: $sha_file"
              else
                echo "âŒ SHA256 éªŒè¯å¤±è´¥: $sha_file"
                exit 1
              fi
            fi
          done

      - name: Update ReleaseLatest branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          VERSION="${{ steps.version.outputs.version }}"
          
          # æ›´æ–° version.json
          echo "{\"version\": \"${VERSION}\"}" > version.json.release
          
          # åˆ›å»ºæˆ–æ›´æ–° ReleaseLatest åˆ†æ”¯
          git fetch origin ReleaseLatest || true
          git checkout -B ReleaseLatest
          
          # ä¿ç•™å¿…è¦æ–‡ä»¶
          cp scripts/install.sh scripts/install.sh.tmp
          cp config/system.json config/system.json.tmp
          
          git checkout --orphan ReleaseLatest-new
          mv version.json.release version.json
          mkdir -p scripts
          mv scripts/install.sh.tmp scripts/install.sh
          mkdir -p config
          mv config/system.json.tmp config/system.json
          
          git add version.json scripts/install.sh config/system.json
          git commit -m "Release ${VERSION} (from ${{ steps.version.outputs.test_tag }})"
          
          git push -f origin HEAD:ReleaseLatest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          body: |
            ## Dec ${{ steps.version.outputs.version }}
            
            > æ­¤ç‰ˆæœ¬ä»Žæµ‹è¯•ç‰ˆæœ¬ `${{ steps.version.outputs.test_tag }}` æå‡è€Œæ¥ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å®Œå…¨ç›¸åŒã€‚
            
            ### å®‰è£…
            ```bash
            curl -fsSL https://raw.githubusercontent.com/shichao402/Dec/ReleaseLatest/scripts/install.sh | bash
            ```
            
            ### æ›´æ–°
            ```bash
            dec update
            ```
            
            ### ä¸‹è½½
            | å¹³å° | æž¶æž„ | ä¸‹è½½ |
            |------|------|------|
            | Linux | AMD64 | [dec-linux-amd64](https://github.com/shichao402/Dec/releases/download/${{ steps.version.outputs.version }}/dec-linux-amd64) |
            | Linux | ARM64 | [dec-linux-arm64](https://github.com/shichao402/Dec/releases/download/${{ steps.version.outputs.version }}/dec-linux-arm64) |
            | macOS | AMD64 | [dec-darwin-amd64](https://github.com/shichao402/Dec/releases/download/${{ steps.version.outputs.version }}/dec-darwin-amd64) |
            | macOS | ARM64 | [dec-darwin-arm64](https://github.com/shichao402/Dec/releases/download/${{ steps.version.outputs.version }}/dec-darwin-arm64) |
            | Windows | AMD64 | [dec-windows-amd64.exe](https://github.com/shichao402/Dec/releases/download/${{ steps.version.outputs.version }}/dec-windows-amd64.exe) |
          files: |
            dist/dec-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- From test: ${{ steps.version.outputs.test_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **åŒä¸€æž„å»ºäº§ç‰©ï¼Œæµ‹è¯•é€šè¿‡åŽç›´æŽ¥å‘å¸ƒ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
