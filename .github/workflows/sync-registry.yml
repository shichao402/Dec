name: Sync Registry

on:
  # å®šæ—¶åŒæ­¥ï¼ˆæ¯å°æ—¶ï¼‰
  schedule:
    - cron: '0 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      repository:
        description: 'æŒ‡å®šä»“åº“ URLï¼ˆç•™ç©ºåˆ™åŒæ­¥å…¨éƒ¨ï¼‰'
        required: false
        type: string
  
  # Issue è§¦å‘ï¼ˆå•åŒ…åŒæ­¥ï¼‰
  issues:
    types: [opened]

jobs:
  # å•åŒ…åŒæ­¥ï¼ˆé€šè¿‡ issue è§¦å‘ï¼‰
  sync-single:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[sync]')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse issue
        id: parse
        run: |
          # ä» issue title æˆ– body æå– repository
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          # å°è¯•ä» title æå–ï¼ˆæ ¼å¼ï¼š[sync] owner/repo æˆ– [sync] https://...ï¼‰
          REPO=$(echo "$TITLE" | sed 's/\[sync\]\s*//' | xargs)
          
          # å¦‚æœä¸æ˜¯å®Œæ•´ URLï¼Œè¡¥å…¨
          if [[ ! "$REPO" =~ ^https:// ]]; then
            REPO="https://github.com/$REPO"
          fi
          
          # è§„èŒƒåŒ–
          REPO=$(echo "$REPO" | sed 's/\.git$//' | sed 's/\/$//')
          echo "repository=$REPO" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Repository: $REPO"

      - name: Sync package
        id: sync
        run: |
          REPO="${{ steps.parse.outputs.repository }}"
          
          # æ£€æŸ¥ä»“åº“æ˜¯å¦åœ¨ registry ä¸­
          if ! jq -e ".packages[] | select(.repository == \"$REPO\")" config/registry.json > /dev/null 2>&1; then
            echo "error=ä»“åº“æœªæ³¨å†Œï¼Œè¯·å…ˆä½¿ç”¨ [auto-register] æ³¨å†Œ" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ä¸‹è½½æœ€æ–°çš„ package.json
          PKG_URL="$REPO/releases/latest/download/package.json"
          if ! curl -sfL "$PKG_URL" -o /tmp/package.json; then
            echo "error=æ— æ³•ä¸‹è½½ package.json" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–ä¿¡æ¯
          NAME=$(jq -r '.name' /tmp/package.json)
          VERSION=$(jq -r '.version' /tmp/package.json)
          
          # æ›´æ–° registry ä¸­å¯¹åº”æ¡ç›®
          jq --arg repo "$REPO" \
             --argjson pkg "$(cat /tmp/package.json)" \
             '(.packages[] | select(.repository == $repo)) |= {
               repository: $repo,
               name: $pkg.name,
               version: $pkg.version,
               description: ($pkg.description // ""),
               author: ($pkg.author // ""),
               dist: $pkg.dist
             }' config/registry.json > /tmp/registry.json
          mv /tmp/registry.json config/registry.json
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "synced=true" >> $GITHUB_OUTPUT
          echo "âœ… å·²åŒæ­¥: $NAME@$VERSION"

      - name: Commit and push
        if: steps.sync.outputs.synced == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/registry.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "chore: sync ${{ steps.sync.outputs.name }}@${{ steps.sync.outputs.version }}"
            git push
          fi

      - name: Comment result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.sync.outputs.synced }}" == "true" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "âœ… **åŒæ­¥æˆåŠŸï¼**

            - **åŒ…å**: ${{ steps.sync.outputs.name }}
            - **ç‰ˆæœ¬**: ${{ steps.sync.outputs.version }}

            ç”¨æˆ·è¿è¡Œ \`cursortoolset update\` å³å¯è·å–æœ€æ–°ç‰ˆæœ¬ã€‚"
          elif [ -n "${{ steps.sync.outputs.error }}" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **åŒæ­¥å¤±è´¥**

            ${{ steps.sync.outputs.error }}"
          fi
          
          gh issue close ${{ github.event.issue.number }}

  # å…¨é‡åŒæ­¥ï¼ˆå®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
  sync-all:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync all packages
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ‰€æœ‰åŒ…..."
          
          # å¦‚æœæŒ‡å®šäº†å•ä¸ªä»“åº“
          SINGLE_REPO="${{ github.event.inputs.repository }}"
          
          # è·å–æ‰€æœ‰ä»“åº“
          REPOS=$(jq -r '.packages[].repository' config/registry.json)
          
          UPDATED=0
          FAILED=0
          
          for REPO in $REPOS; do
            # å¦‚æœæŒ‡å®šäº†å•ä¸ªä»“åº“ï¼Œè·³è¿‡å…¶ä»–
            if [ -n "$SINGLE_REPO" ] && [ "$REPO" != "$SINGLE_REPO" ]; then
              continue
            fi
            
            echo ""
            echo "ğŸ“¦ åŒæ­¥: $REPO"
            
            # ä¸‹è½½ package.json
            PKG_URL="$REPO/releases/latest/download/package.json"
            if ! curl -sfL "$PKG_URL" -o /tmp/package.json 2>/dev/null; then
              echo "  âš ï¸ è·³è¿‡ï¼ˆæ— æ³•ä¸‹è½½ package.jsonï¼‰"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            # éªŒè¯ JSON
            if ! jq -e '.name' /tmp/package.json > /dev/null 2>&1; then
              echo "  âš ï¸ è·³è¿‡ï¼ˆpackage.json æ ¼å¼é”™è¯¯ï¼‰"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            NAME=$(jq -r '.name' /tmp/package.json)
            VERSION=$(jq -r '.version' /tmp/package.json)
            
            # æ›´æ–° registry
            jq --arg repo "$REPO" \
               --argjson pkg "$(cat /tmp/package.json)" \
               '(.packages[] | select(.repository == $repo)) |= {
                 repository: $repo,
                 name: $pkg.name,
                 version: $pkg.version,
                 description: ($pkg.description // ""),
                 author: ($pkg.author // ""),
                 dist: $pkg.dist
               }' config/registry.json > /tmp/registry.json
            mv /tmp/registry.json config/registry.json
            
            echo "  âœ… $NAME@$VERSION"
            UPDATED=$((UPDATED + 1))
          done
          
          echo ""
          echo "ğŸ“Š åŒæ­¥å®Œæˆ: $UPDATED æˆåŠŸ, $FAILED å¤±è´¥"

      - name: Update registry version
        run: |
          # æ›´æ–° registry çš„æ—¶é—´æˆ³
          jq --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '.updated_at = $ts' config/registry.json > /tmp/registry.json
          mv /tmp/registry.json config/registry.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/registry.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "chore: sync registry $(date -u +%Y-%m-%d)"
            git push
          fi
