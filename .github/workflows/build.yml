name: Build Pipeline

# è§¦å‘æ¡ä»¶ï¼šbuild åˆ†æ”¯è¢«åˆ›å»ºæˆ–æŽ¨é€
on:
  push:
    branches:
      - 'build'
      - 'build-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'æž„å»ºç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.1ï¼‰'
        required: false
        default: 'dev'

permissions:
  contents: write

jobs:
  # æž„å»ºä¿¡æ¯
  build-info:
    name: å‡†å¤‡æž„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_time: ${{ steps.version.outputs.build_time }}
      branch: ${{ steps.version.outputs.branch }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          # ä»Ž version.json è¯»å–ç‰ˆæœ¬å·
          if [ ! -f "version.json" ]; then
            echo "âŒ é”™è¯¯: version.json æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          VERSION=$(cat version.json | grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: version.json ä¸­æœªæ‰¾åˆ° version å­—æ®µ"
            exit 1
          fi
          
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          COMMIT=$(git rev-parse --short HEAD)
          BRANCH="${GITHUB_REF#refs/heads/}"
          
          # æ›´æ–° version.json ä¸­çš„æž„å»ºä¿¡æ¯
          cat > version.json << EOF
          {
            "version": "$VERSION",
            "build_time": "$BUILD_TIME",
            "commit": "$COMMIT",
            "branch": "$BRANCH"
          }
          EOF
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ æž„å»ºç‰ˆæœ¬: $VERSION"
          echo "â° æž„å»ºæ—¶é—´: $BUILD_TIME"
          echo "ðŸ”– æäº¤å“ˆå¸Œ: $COMMIT"
          echo "ðŸŒ¿ æž„å»ºåˆ†æ”¯: $BRANCH"

  # å¤šå¹³å°æž„å»º
  build:
    name: æž„å»º ${{ matrix.os }}-${{ matrix.arch }}
    needs: build-info
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
          # macOS
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          # Windows
          - os: windows
            arch: amd64
            runner: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: æž„å»º
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ needs.build-info.outputs.version }}
          BUILD_TIME: ${{ needs.build-info.outputs.build_time }}
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»º ${{ matrix.os }}-${{ matrix.arch }}"
          echo "ðŸ“Œ ç‰ˆæœ¬: $VERSION"
          
          BINARY_NAME="cursortoolset-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME" -o "$BINARY_NAME" .
          
          echo "âœ… æž„å»ºå®Œæˆ: $BINARY_NAME"
          ls -lh "$BINARY_NAME"
        shell: bash
      
      - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          BINARY_NAME="cursortoolset-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          echo "ðŸ§ª æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶..."
          
          # æ£€æŸ¥æž¶æž„æ˜¯å¦åŒ¹é…ï¼ˆé¿å…è·¨æž¶æž„æ‰§è¡Œé”™è¯¯ï¼‰
          RUNNER_ARCH=$(uname -m)
          TARGET_ARCH="${{ matrix.arch }}"
          
          # æž¶æž„æ˜ å°„
          case "$RUNNER_ARCH" in
            x86_64)
              RUNNER_ARCH_NORM="amd64"
              ;;
            aarch64|arm64)
              RUNNER_ARCH_NORM="arm64"
              ;;
            *)
              RUNNER_ARCH_NORM="$RUNNER_ARCH"
              ;;
          esac
          
          if [ "$RUNNER_ARCH_NORM" = "$TARGET_ARCH" ]; then
            chmod +x "$BINARY_NAME" || true
            ./"$BINARY_NAME" --version
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸  è·³è¿‡è·¨æž¶æž„æµ‹è¯•ï¼ˆRunner: $RUNNER_ARCH_NORM, Target: $TARGET_ARCHï¼‰"
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å·²ç”Ÿæˆï¼Œæž¶æž„éªŒè¯é€šè¿‡"
            ls -lh "$BINARY_NAME"
          fi
        shell: bash
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          BINARY_NAME="cursortoolset-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$BINARY_NAME" > "$BINARY_NAME.sha256"
          else
            shasum -a 256 "$BINARY_NAME" > "$BINARY_NAME.sha256"
          fi
          
          echo "ðŸ“‹ æ ¡éªŒå’Œ:"
          cat "$BINARY_NAME.sha256"
        shell: bash
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: cursortoolset-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            cursortoolset-*
          retention-days: 30
  
  # æž„å»ºæ€»ç»“
  build-summary:
    name: æž„å»ºæ€»ç»“
    needs: [build-info, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: ç”Ÿæˆæž„å»ºæ€»ç»“
        run: |
          echo "# æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.build-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: ${{ needs.build-info.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ needs.build-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æž¶æž„ | å¤§å° | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          cd artifacts
          for dir in */; do
            cd "$dir"
            for file in cursortoolset-*; do
              if [[ ! "$file" =~ \.sha256$ ]]; then
                SIZE=$(ls -lh "$file" | awk '{print $5}')
                SHA=$(cat "${file}.sha256" 2>/dev/null | awk '{print substr($1,1,16)"..."}' || echo "N/A")
                PLATFORM=$(echo "$file" | sed 's/cursortoolset-//' | sed 's/-.*//')
                ARCH=$(echo "$file" | sed 's/.*-//' | sed 's/\.exe$//')
                echo "| $PLATFORM | $ARCH | $SIZE | \`$SHA\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            cd ..
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰å¹³å°æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œä¿ç•™ 30 å¤©ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚éœ€å‘å¸ƒï¼Œè¯·è¿è¡Œ **Release Pipeline** å·¥ä½œæµï¼ŒæŒ‡å®šæ­¤æž„å»ºçš„ç‰ˆæœ¬å·ã€‚" >> $GITHUB_STEP_SUMMARY
      
      - name: åˆ—å‡ºæ‰€æœ‰æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ“¦ æ‰€æœ‰æž„å»ºäº§ç‰©:"
          find artifacts -type f ! -name "*.sha256" -exec ls -lh {} \;

