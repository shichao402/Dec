name: Sync Registry

on:
  # å®šæ—¶åŒæ­¥ï¼ˆæ¯å¤© UTC 0:00ï¼Œä½œä¸ºå…œåº•æœºåˆ¶ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      repository:
        description: 'æŒ‡å®šä»“åº“ URLï¼ˆç•™ç©ºåˆ™åŒæ­¥å…¨éƒ¨ï¼‰'
        required: false
        type: string
  
  # Issue è§¦å‘ï¼ˆå•åŒ…åŒæ­¥ï¼‰
  # æ”¯æŒï¼š
  # - dec publish-notify åˆ›å»ºçš„ [pack-sync] Issue
  # - æ‰‹åŠ¨åˆ›å»ºçš„å¸¦ pack-sync label çš„ Issue
  issues:
    types: [opened]

  # Repository dispatch è§¦å‘ï¼ˆåŒ…å‘å¸ƒåè‡ªåŠ¨åŒæ­¥ï¼‰
  repository_dispatch:
    types: [package-released]

jobs:
  # å•åŒ…åŒæ­¥ï¼ˆé€šè¿‡ issue è§¦å‘ï¼‰
  sync-single:
    # æ”¯æŒä¸¤ç§è§¦å‘æ–¹å¼ï¼š
    # 1. Issue å¸¦æœ‰ pack-sync labelï¼ˆæ¨èï¼Œdec publish-notify ä½¿ç”¨ï¼‰
    # 2. Issue æ ‡é¢˜ä»¥ [pack-sync] æˆ– [sync] å¼€å¤´ï¼ˆå…¼å®¹æ‰‹åŠ¨åˆ›å»ºï¼‰
    if: |
      github.event_name == 'issues' && (
        contains(github.event.issue.labels.*.name, 'pack-sync') ||
        startsWith(github.event.issue.title, '[pack-sync]') ||
        startsWith(github.event.issue.title, '[sync]')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse issue
        id: parse
        run: |
          # æ”¯æŒå¤šç§ Issue æ ¼å¼ï¼š
          # 1. dec publish-notify åˆ›å»ºçš„ JSON ä»£ç å—æ ¼å¼
          # 2. github-issue å·¥å…·åˆ›å»ºçš„ Gist payload æ ¼å¼
          # 3. æ‰‹åŠ¨åˆ›å»ºçš„ repository: https://... æ ¼å¼
          # 4. æ ‡é¢˜ä¸­çš„ [sync] owner/repo æ ¼å¼
          
          BODY="${{ github.event.issue.body }}"
          TITLE="${{ github.event.issue.title }}"
          
          # æ–¹æ¡ˆ 1: ä» JSON ä»£ç å—ä¸­æå– repositoryï¼ˆdec publish-notify æ ¼å¼ï¼‰
          echo "ğŸ“¦ å°è¯•ä» JSON ä»£ç å—è§£æ..."
          REPO=$(echo "$BODY" | sed -n '/```json/,/```/p' | grep -oP '"repository":\s*"\K[^"]+' | head -1 || echo "")
          
          if [ -n "$REPO" ] && [ "$REPO" != "null" ]; then
            echo "âœ… ä» JSON ä»£ç å—è¯»å–åˆ° repository: $REPO"
            # è§„èŒƒåŒ–
            REPO=$(echo "$REPO" | sed 's/\.git$//' | sed 's/\/$//')
            echo "repository=$REPO" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Repository: $REPO"
            exit 0
          fi
          
          # æ–¹æ¡ˆ 2: ä» Gist URL è¯»å– payloadï¼ˆgithub-issue å·¥å…·æ ¼å¼ï¼‰
          GIST_URL=$(echo "$BODY" | grep -oP 'https://gist\.github\.com/[^\s\)]+' | head -1 || echo "")
          
          if [ -n "$GIST_URL" ]; then
            echo "ğŸ“¦ ä» Gist è¯»å– payload..."
            GIST_ID=$(echo "$GIST_URL" | sed 's|https://gist.github.com/||' | awk '{print $1}')
            PAYLOAD_URL="https://gist.githubusercontent.com/$GIST_ID/raw"
            if curl -sfL "$PAYLOAD_URL" -o /tmp/payload.json; then
              REPO=$(jq -r '.repository // empty' /tmp/payload.json)
              if [ -n "$REPO" ] && [ "$REPO" != "null" ]; then
                echo "âœ… ä» Gist payload è¯»å–åˆ° repository: $REPO"
                REPO=$(echo "$REPO" | sed 's/\.git$//' | sed 's/\/$//')
                echo "repository=$REPO" >> $GITHUB_OUTPUT
                echo "ğŸ“¦ Repository: $REPO"
                exit 0
              fi
            fi
          fi
          
          # æ–¹æ¡ˆ 3: ä» body æå– repository: https://... æ ¼å¼
          echo "ğŸ“¦ ä» issue body è§£æ repository..."
          REPO=$(echo "$BODY" | grep -oP 'repository:\s*\K(https://github.com/[^\s\)\"]+)' | head -1 || echo "")
          
          if [ -n "$REPO" ]; then
            echo "âœ… ä» body è¯»å–åˆ° repository: $REPO"
            REPO=$(echo "$REPO" | sed 's/\.git$//' | sed 's/\/$//')
            echo "repository=$REPO" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Repository: $REPO"
            exit 0
          fi
          
          # æ–¹æ¡ˆ 4: ä» title è§£æï¼ˆ[sync] æˆ– [pack-sync] å‰ç¼€ï¼‰
          echo "ğŸ“¦ ä» issue title è§£æ repository..."
          REPO=$(echo "$TITLE" | sed 's/^\[sync\]\s*//' | sed 's/^\[pack-sync\]\s*//' | xargs)
          
          # ç§»é™¤ç‰ˆæœ¬å·ï¼ˆåŒ¹é… @1.2.3 æˆ– v1.2.3 æˆ– 1.2.3 æ ¼å¼ï¼‰
          REPO=$(echo "$REPO" | sed 's/@[0-9].*$//' | sed 's/\s*v[0-9].*$//' | sed 's/\s*[0-9]\+\.[0-9]\+\.[0-9].*$//')
          
          if [[ "$REPO" =~ ^https://github.com/ ]]; then
            # å·²ç»æ˜¯å®Œæ•´ URL
            :
          elif [[ "$REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            # owner/repo æ ¼å¼ï¼Œè¡¥å…¨ä¸ºå®Œæ•´ URL
            REPO="https://github.com/$REPO"
          else
            # å¯èƒ½æ˜¯åŒ…åï¼Œå°è¯•ä» registry æŸ¥æ‰¾
            PKG_NAME="$REPO"
            REPO=$(jq -r --arg name "$PKG_NAME" '.packages[] | select(.name == $name) | .repository' config/registry.json 2>/dev/null || echo "")
          fi
          
          # è§„èŒƒåŒ–
          REPO=$(echo "$REPO" | sed 's/\.git$//' | sed 's/\/$//')
          
          if [ -z "$REPO" ]; then
            echo "error=æ— æ³•ä» issue ä¸­æå– repository URL" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "repository=$REPO" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Repository: $REPO"

      - name: Sync package
        id: sync
        run: |
          REPO="${{ steps.parse.outputs.repository }}"
          
          # æ£€æŸ¥ä»“åº“æ˜¯å¦åœ¨ registry ä¸­
          if ! jq -e ".packages[] | select(.repository == \"$REPO\")" config/registry.json > /dev/null 2>&1; then
            echo "error=ä»“åº“æœªæ³¨å†Œï¼Œè¯·å…ˆä½¿ç”¨ [auto-register] æ³¨å†Œ" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ä¸‹è½½æœ€æ–°çš„ package.json
          PKG_URL="$REPO/releases/latest/download/package.json"
          if ! curl -sfL "$PKG_URL" -o /tmp/package.json; then
            echo "error=æ— æ³•ä¸‹è½½ package.json" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–ä¿¡æ¯
          NAME=$(jq -r '.name' /tmp/package.json)
          VERSION=$(jq -r '.version' /tmp/package.json)
          
          # æ›´æ–° registry ä¸­å¯¹åº”æ¡ç›®ï¼ˆä¿ç•™ type å’Œ mcp å­—æ®µï¼‰
          jq --arg repo "$REPO" \
             --argjson pkg "$(cat /tmp/package.json)" \
             '(.packages[] | select(.repository == $repo)) |= (
               . + {
                 repository: $repo,
                 name: $pkg.name,
                 version: $pkg.version,
                 type: ($pkg.type // .type // "rule"),
                 description: ($pkg.description // ""),
                 author: ($pkg.author // ""),
                 dist: $pkg.dist
               } + (if $pkg.mcp then {mcp: $pkg.mcp} else {} end)
             )' config/registry.json > /tmp/registry.json
          mv /tmp/registry.json config/registry.json
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "synced=true" >> $GITHUB_OUTPUT
          echo "âœ… å·²åŒæ­¥: $NAME@$VERSION"

      - name: Commit and push
        if: steps.sync.outputs.synced == 'true'
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/registry.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: sync ${{ steps.sync.outputs.name }}@${{ steps.sync.outputs.version }}"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Update registry release
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¦ æ›´æ–° registry release..."
          if gh release view registry &>/dev/null; then
            gh release upload registry config/registry.json --clobber
          else
            gh release create registry \
              --title "Package Registry" \
              --notes "This release contains the package registry for Dec." \
              config/registry.json
          fi
          echo "âœ… Registry release æ›´æ–°å®Œæˆ"

      - name: Comment result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.sync.outputs.synced }}" == "true" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "âœ… **åŒæ­¥æˆåŠŸï¼**

            - **åŒ…å**: ${{ steps.sync.outputs.name }}
            - **ç‰ˆæœ¬**: ${{ steps.sync.outputs.version }}

            ç”¨æˆ·è¿è¡Œ \`dec update\` å³å¯è·å–æœ€æ–°ç‰ˆæœ¬ã€‚"
          elif [ -n "${{ steps.sync.outputs.error }}" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **åŒæ­¥å¤±è´¥**

            ${{ steps.sync.outputs.error }}"
          fi
          
          gh issue close ${{ github.event.issue.number }}

  # å…¨é‡åŒæ­¥ï¼ˆå®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰æˆ–å•åŒ…åŒæ­¥ï¼ˆrepository_dispatchï¼‰
  sync-all:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync all packages
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ‰€æœ‰åŒ…..."
          
          # å¦‚æœæŒ‡å®šäº†å•ä¸ªä»“åº“ï¼ˆæ¥è‡ª workflow_dispatch æˆ– repository_dispatchï¼‰
          SINGLE_REPO="${{ github.event.inputs.repository }}"
          
          # repository_dispatch è§¦å‘æ—¶ä» client_payload è·å–ä»“åº“
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            SINGLE_REPO="${{ github.event.client_payload.repository }}"
            echo "ğŸ“¦ è§¦å‘æ¥æº: repository_dispatch"
            echo "ğŸ“¦ åŒæ­¥ä»“åº“: $SINGLE_REPO"
          fi
          
          # è·å–æ‰€æœ‰ä»“åº“
          REPOS=$(jq -r '.packages[].repository' config/registry.json)
          
          UPDATED=0
          FAILED=0
          
          for REPO in $REPOS; do
            # å¦‚æœæŒ‡å®šäº†å•ä¸ªä»“åº“ï¼Œè·³è¿‡å…¶ä»–
            if [ -n "$SINGLE_REPO" ] && [ "$REPO" != "$SINGLE_REPO" ]; then
              continue
            fi
            
            echo ""
            echo "ğŸ“¦ åŒæ­¥: $REPO"
            
            # ä¸‹è½½ package.json
            PKG_URL="$REPO/releases/latest/download/package.json"
            if ! curl -sfL "$PKG_URL" -o /tmp/package.json 2>/dev/null; then
              echo "  âš ï¸ è·³è¿‡ï¼ˆæ— æ³•ä¸‹è½½ package.jsonï¼‰"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            # éªŒè¯ JSON
            if ! jq -e '.name' /tmp/package.json > /dev/null 2>&1; then
              echo "  âš ï¸ è·³è¿‡ï¼ˆpackage.json æ ¼å¼é”™è¯¯ï¼‰"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            NAME=$(jq -r '.name' /tmp/package.json)
            VERSION=$(jq -r '.version' /tmp/package.json)
            
            # æ›´æ–° registryï¼ˆä¿ç•™ type å’Œ mcp å­—æ®µï¼‰
            jq --arg repo "$REPO" \
               --argjson pkg "$(cat /tmp/package.json)" \
               '(.packages[] | select(.repository == $repo)) |= (
                 . + {
                   repository: $repo,
                   name: $pkg.name,
                   version: $pkg.version,
                   type: ($pkg.type // .type // "rule"),
                   description: ($pkg.description // ""),
                   author: ($pkg.author // ""),
                   dist: $pkg.dist
                 } + (if $pkg.mcp then {mcp: $pkg.mcp} else {} end)
               )' config/registry.json > /tmp/registry.json
            mv /tmp/registry.json config/registry.json
            
            echo "  âœ… $NAME@$VERSION"
            UPDATED=$((UPDATED + 1))
          done
          
          echo ""
          echo "ğŸ“Š åŒæ­¥å®Œæˆ: $UPDATED æˆåŠŸ, $FAILED å¤±è´¥"

      - name: Update registry version
        run: |
          # æ›´æ–° registry çš„æ—¶é—´æˆ³
          jq --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '.updated_at = $ts' config/registry.json > /tmp/registry.json
          mv /tmp/registry.json config/registry.json

      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/registry.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: sync registry $(date -u +%Y-%m-%d)"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Update registry release
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¦ æ›´æ–° registry release..."
          # æ£€æŸ¥ registry release æ˜¯å¦å­˜åœ¨
          if gh release view registry &>/dev/null; then
            gh release upload registry config/registry.json --clobber
          else
            gh release create registry \
              --title "Package Registry" \
              --notes "This release contains the package registry for Dec." \
              config/registry.json
          fi
          echo "âœ… Registry release æ›´æ–°å®Œæˆ"
